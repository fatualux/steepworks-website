image: alpine:latest

stages:
  - deploy

variables:
  PUBLIC_DIR: public
  ARTIFACTS_EXPIRE: 1 week

cache:
  paths:
    - $PUBLIC_DIR

before_script:
  - apk add --no-cache rsync

pages:
  stage: deploy
  script:
    - mkdir -p $PUBLIC_DIR
    # Copy all files to public directory
    - find . -type f -not -path "./$PUBLIC_DIR/*" -not -path "./.*" -not -path "./assets/js/*" -not -path "./assets/css/*" -exec cp --parents {} $PUBLIC_DIR/ \;
    # Copy assets
    - [ -d "assets" ] && cp -r assets $PUBLIC_DIR/ || echo "No assets directory found"
    # Create .nojekyll to prevent Jekyll processing
    - touch $PUBLIC_DIR/.nojekyll
    # Copy CNAME file if it exists
    - [ -f "CNAME" ] && cp CNAME $PUBLIC_DIR/ || echo "No CNAME file found"
  artifacts:
    paths:
      - $PUBLIC_DIR
    expire_in: $ARTIFACTS_EXPIRE
  only:
    - main  # or the name of your default branch

# Add a job to verify the CNAME file
check_cname:
  stage: deploy
  script:
    - |
      if [ -f "CNAME" ]; then
        echo "CNAME file found: $(cat CNAME)"
      else
        echo "No CNAME file found. Your site will be available at https://<username>.gitlab.io/<repository-name>/"
      fi
  allow_failure: true
  only:
    - main
